
<html>
  <head>
    <title>U.S. Census Population Pyramid</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script type="text/javascript" src="d3.min.js"></script>
    <script type="text/javascript" src="census.js"></script>
    <style type="text/css">

body {
  font: 12px sans-serif;
  margin: 0;
  padding: 5px;
  color: #888;
}
h1 {
  padding-left: 10px;
  margin-bottom: 2px;
  color: #333;
}
.source {
  padding-left: 10px;
}
.source a, .source a:hover {
  color: #888;
}
.label {
  position: absolute;
  top: 60px;
  left: 15px;
  font-size: 48px;
  font-weight: bold;
  color: #dedede;
}
.break {
  border-bottom: solid 1px #dedede;
  margin: 10px 15px 2px 15px;
  width: 545px;
}
.years, .controls {
  padding-top: 10px;
  padding-left: 15;
  width: 540;
  text-align: center;
  font-size: 12px;
}
.years span, .controls span {
  padding-left: 2px;
  padding-right: 2px;
}
.years .title {
  font-size: 13px;
  font-variant: small-caps;
  letter-spacing: 1;
}
.years a, .controls a {
  color: #888;
  text-decoration: none;
}
.years a.y1890 {
  color: #bbb;
}
.years a.active {
  color: #000;
}
.controls a {
  font-variant: small-caps;
  letter-spacing: 1;
  text-decoration: none;
}
.controls a:hover {
  color: #000;
  text-decoration: underline;
}
svg {
  shape-rendering: crispEdges;
}
    </style>
  </head>
  <body>
  <h1>U.S. Census Population Pyramid, 1850-2000</h1>
    <div class="source">
    Source: U.S. Census &amp; Minnesota Population Center, <a href="ipums.org">ipums.org</a>.
    </div>
    <script type="text/javascript">

function isYear(d) { return d.year == year; }
function linkClass(y) { return "y"+y.toFixed(0) + (y==year?" active":""); }
function tooltipText(d) {
    return d3.format(",")(d.people)
        + " " + (d.sex==1?"men":"women")
        + " aged " + (d.age==90?"90+":d.age+"-"+(d.age+4))
      + " in " + d.year;
}
function barWidth(d) { return x1(d.people); }

function goto(y, dur) {
  dur = dur || 300;
  year = y;
  label.text(year);
  div.selectAll("span.link a")
     .attr("class", linkClass);

  mbars.data(mdat.filter(isYear))
     .transition()
       .duration(dur)
         .attr("width", function(d) { return x1(d.people); });
  mbars.select("title").text(tooltipText);

  fbars.data(fdat.filter(isYear))
       .transition()
         .duration(dur)
       .attr("transform", function(d) { return "translate("+(x2(d.people))+",0)";})
       .attr("width", function(d) { return x1(d.people); });
  fbars.select("title").text(tooltipText);
}

var timer = undefined;
function stop() {
    clearInterval(timer);
    timer = undefined;
    ctrls.select("a.toggle").text("play");
}
function toggle() {
  if (!timer) {
    year = 1840;
    play();
  } else {
    stop();
  }
}
function play(rev) {
  rev = rev || false;
  if (timer) { stop(); }
  ctrls.select("a.toggle").text("stop");
  var advance = function() {
    var y = year + (rev?-1:1)*10;
    if (y == 1890) {
      // skip 1890
      y = y + (rev?-1:1)*10;
    }
    if (y < 1850 || y > 2000) {
      // stop at end points
      stop();
      return;
    } else {
      // else advance
      goto(y, 800);
    }
  };
  advance();
  timer = setInterval(advance, 850);
}

var data = census,
    maxp = data.reduce(function(a,b) { return Math.max(a,b.people); }, 0),
    mdat = data.filter(function(d) { return d.sex==1; })
               .sort(function(a,b) { return b.age - a.age; }),
    fdat = data.filter(function(d) { return d.sex==2; })
               .sort(function(a,b) { return b.age - a.age; });

var w = 250,
    h = 19 * 20,
    bins = d3.range(19),
    year = 2000,
    y = d3.scale.ordinal().domain(bins).rangeBands([0, h], .3),
    x1 = d3.scale.linear().domain([0, maxp]).range([0, w]),
    x2 = d3.scale.linear().domain([0, maxp]).range([w, 0]),
    rf = "javascript:return false;";

var label = d3.select("body")
  .append("div")
    .attr("class", "label")
    .text("2000");

var vis = d3.select("body")
  .append("svg:svg")
    .attr("width", 2*w + 40)
    .attr("height", h + 40)
  .append("svg:g")
    .attr("transform", "translate(20,15)");

// pyramid bar chart

var bars = vis.selectAll("g.bar")
    .data(bins)
    .enter()
    .append("svg:g")
    .attr("class", "bar")
    .attr("transform", function(d, i) { return "translate(0," + y(i) + ")"; });

bars.append("svg:text")
    .filter(function(d) { return d%2==0; })
    .attr("x", w+15)
    .attr("y", y.rangeBand() - 2)
    .attr("fill", "#888")
    .attr("text-anchor", "middle")
    .attr("font-size", "12px")
    .text(function(d) { return (90-d*5).toFixed(0); });

var mbars = bars.append("svg:rect")
    .data(mdat.filter(isYear))
    .attr("fill", "steelblue")
    .attr("transform", function(d) { return "translate("+(w+30)+",0)";})
    .attr("width", barWidth)
    .attr("height", y.rangeBand());

mbars.append("svg:title").text(tooltipText);

var fbars = bars.append("svg:rect")
    .data(fdat.filter(isYear))
    .attr("fill", "pink")
    .attr("transform", function(d) { return "translate("+(x2(d.people))+",0)";})
    .attr("width", barWidth)
    .attr("height", y.rangeBand());

fbars.append("svg:title").text(tooltipText);

mbars.attr("width", 0)
    .transition()
      .duration(500)
      .delay(function(d,i) { return 30*i; })
      .attr("width", barWidth);

fbars.attr("width", 1)
     .attr("transform", "translate("+w+",0)")
    .transition()
      .duration(500)
      .delay(function(d, i) { return 30*i; })
      .attr("width", barWidth)
      .attr("transform", function(d) { return "translate("+(x2(d.people))+",0)";});

// age label

vis.append("svg:text")
    .attr("x", w+15)
    .attr("y", h+8)
    .attr("dy", ".71em")
    .attr("fill", "#888")
    .attr("text-anchor", "middle")
    .attr("font-size", "13px")
    .attr("font-variant", "small-caps")
    .attr("letter-spacing", 1)
    .text("age");

// gridlines and labels for right pyramid

var rules1 = vis.selectAll("g.rule1")
    .data(x1.ticks(5))
    .enter()
    .append("svg:g")
    .filter(function(d) { return d > 0; })
    .attr("class", "rule1")
    .attr("transform", function(d) { return "translate("+(w+30+x1(d))+",0)";});

rules1.append("svg:line")
    .attr("y1", h - 2)
    .attr("y2", h + 4)
    .attr("stroke", "#bbb");

rules1.append("svg:line")
    .attr("y1", 0)
    .attr("y2", h)
    .attr("stroke", "white")
    .attr("stroke-opacity", .3);

rules1.append("svg:text")
    .attr("y", h + 9)
    .attr("dy", ".71em")
    .attr("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("fill", "#bbb")
    .text(function(d) { return (d/1000000).toFixed(0)+"M"; });

// gridlines and labels for left pyramid

var rules2 = vis.selectAll("g.rule2")
    .data(x2.ticks(5))
    .enter()
    .append("svg:g")
    .filter(function(d) { return d > 0; })
    .attr("class", "rule2")
    .attr("transform", function(d) { return "translate("+(x2(d))+",0)";});

rules2.append("svg:line")
    .attr("y1", h - 2)
    .attr("y2", h + 4)
    .attr("stroke", "#bbb");

rules2.append("svg:line")
    .attr("y1", 0)
    .attr("y2", h)
    .attr("stroke", "white")
    .attr("stroke-opacity", .3);

rules2.append("svg:text")
    .attr("y", h + 9)
    .attr("dy", ".71em")
    .attr("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("fill", "#bbb")
    .text(function(d) { return (d/1000000).toFixed(0)+(d==0?"":"M"); });

d3.select("body")
  .append("div")
    .attr("class", "break");

var div = d3.select("body")
  .append("div")
    .attr("class", "years");

div.append("span")
  .attr("class", "title")
  .text("year");

var ctrls = d3.select("body")
  .append("div")
  .attr("class", "controls");
ctrls.append("span").append("a")
  .attr("class", "control back")
  .attr("href", "javascript:play(true);")
  .text("<< ");
ctrls.append("span").append("a")
  .attr("class", "control toggle")
  .attr("href", "javascript:toggle();")
  .text("play");
ctrls.append("span").append("a")
  .attr("class", "control forward")
  .attr("href", "javascript:play();")
  .text(" >>");

div.selectAll("span.link")
    .data(d3.range(1850, 2001, 10))
  .enter()
  .append("span")
    .attr("class", "link")
  .append("a")
    .attr("class", linkClass)
    .attr("href", function(d) { return d==1890?null:"javascript:goto("+d+");"; })
    .text(function(d) { return d.toFixed(0); });

div.select("a.y1890")
    .attr("title", "Most of the 1890 census was destroyed in "+
        "1921 during a fire in the basement of the "+
        "Commerce Building in Washington, D.C.");

    </script>
  </body>
</html>
