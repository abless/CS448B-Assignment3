<!DOCTYPE html>
<html>
  <head>
    <title>Bar Chart</title>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js?1.29.1"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.time.js?1.29.1"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.csv.js?1.29.1"></script>
    <style type="text/css">

body {
  font: 10px sans-serif;
}

svg {
  shape-rendering: crispEdges;
}

</style>
</head>
<body>
  <script type="text/javascript">

var year = 1999;

//d3.csv("data/mockup.csv", function(data) {
d3.csv("data/US_mortality.top10cause.csv", function(data) {
  data.forEach(function(d) {
    d.people = +d.people;
    d.year = +d.year;
  });
    var causeData = d3.nest().key(function(d) { return d.cause; }).map(data);
    var ageData = d3.nest().key(function(d) { return d.age; }).map(data);

    dataYear = data.filter(function(d) { return d.year == year; });
    // gender: 1 male 2 female
    var mdata = dataYear.filter(function(d) { return d.gender == 1; });
    var fdata = dataYear.filter(function(d) { return d.gender == 2; });

    var ageGroup = Array();
    var mageLength = Array();
    var fageLength = Array();
    for (var age in ageData)
    {
        ageGroup.push(age);
        mageLength[age] = 0;
        fageLength[age] = 0;
    }

    var causeGroup = Array();
    var causeColor = Array();
    for (var cause in causeData)
    {
        causeGroup.push(cause);
        causeColor[cause] = "rgb(" + parseInt(Math.random() * 255) + "," + parseInt(Math.random() * 255) + "," + parseInt(Math.random() * 255) + ")";
    }

    var w = 600,
        h = 430,
        xRight = d3.scale.linear().domain([0, 500000]).range([0, w]),
        xLeft = d3.scale.linear().domain([0, 500000]).range([w, 0]),
        y = d3.scale.ordinal().domain(ageGroup).rangeBands([0, h], .2);

    var vis = d3.select("body")
        .append("svg:svg")
        .attr("width", w + 40)
        .attr("height", h + 40)
        .append("svg:g")
        .attr("transform", "translate(20,15)");

    var ageText = vis.selectAll("text")
        .data(ageGroup)
        .enter().append("svg:text")
        .attr("x", "340")
        .attr("y", function(d) { return y(d); })
        .attr("text-anchor", "middle")
        .attr("dy", ".71em")
        .text(function(d) { return d; });

    var bars = vis.selectAll("g.bar")
        .data(ageGroup)
        .enter().append("svg:g")
        .attr("class", "bar")
        .attr("transform", function(d, i) { return "translate(320, 0)"; });

    bars.each(function(d, i) {
        var causes = mdata.filter(function (d) { return d.age == ageGroup[i]; })

        d3.select(this).selectAll("g.bar")
        .data(causes)
        .enter()
        .append("svg:rect")
        //.attr("fill", "steelblue")
        .attr("fill", function(d) { return causeColor[d.cause]; })
        .attr("y", function(d) { return y(d.age); })
        .attr("x", function(d) { var temp = mageLength[d.age] + 40; mageLength[d.age] += xRight(d.people); return temp; })
        .attr("width", function(d) { return xRight(d.people);})
        .attr("height", y.rangeBand());
    });

    bars.each(function(d, i) {
        var causes = fdata.filter(function (d) { return d.age == ageGroup[i]; });

        d3.select(this).selectAll("g.bar")
        .data(causes)
        .enter()
        .append("svg:rect")
        //.attr("fill", "steelblue")
        .attr("fill", function(d) { return causeColor[d.cause]; })
        .attr("y", function(d) { return y(d.age); })
        .attr("x", function(d) { var temp = fageLength[d.age] - xRight(d.people); fageLength[d.age] -= xRight(d.people); return temp; })
        .attr("width", function(d) { return xRight(d.people);})
        .attr("height", y.rangeBand());
    });

    var mbars = d3.selectAll("rect[gender='male']");
    var fbars = d3.selectAll("rect[gender='female']");
    var allbars = d3.selectAll("rect").attr("opacity", 1);

    allbars
      .on("mouseover", function(d) {
        allbars
        .filter(function(d2) { return d.cause != d2.cause })
        .transition()
        .attr("opacity", 0.3);
       })
      .on("mouseout", function() { allbars.transition().attr("opacity", 1); });

    var rules = vis.selectAll("g.rule")
        .data(xRight.ticks(10))
        .enter().append("svg:g")
        .attr("class", "rule")
        .attr("transform", function(d) { return "translate(" + xRight(d) + ",0)"; });

    rules.append("svg:line")
        .attr("y1", h)
        .attr("y2", h + 6)
        .attr("stroke", "black");

    rules.append("svg:line")
        .attr("y1", 0)
        .attr("y2", h)
        .attr("stroke", "black")
        .attr("stroke-opacity", .1);

    rules.append("svg:text")
        .attr("y", h + 9)
        .attr("dy", ".71em")
        .attr("text-anchor", "middle")
        .text(xRight.tickFormat(10));

});



</script>
</body>
</html>
